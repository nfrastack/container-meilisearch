# SPDX-FileCopyrightText: Â© 2025 Nfrastack <code@nfrastack.com>
#
# SPDX-License-Identifier: MIT

meilisearch_bootstrap_filesystem() {
    if [ "${MEILISEARCH_SETUP_TYPE,,}" = "auto" ]; then
        create_folder \
                    "${CONFIG_PATH},\
                    ${DATA_PATH},\
                    ${DB_PATH},\
                    ${DUMP_PATH},\
                    ${LOG_PATH},\
                    ${SNAPSHOT_PATH}" \
                    "${MEILISEARCH_USER}":"${MEILISEARCH_GROUP}" 750

        case "${LOG_TYPE,,}" in
            file )
                create_folder \
                                "${LOG_PATH}" \
                                "${MEILISEARCH_USER}":"${MEILISEARCH_GROUP}" 750
                create_logrotate meilisearch "${LOG_PATH%/}"/"${LOG_FILE}" "${MEILISEARCH_USER}" "${MEILISEARCH_GROUP}" meilisearch
                logfile="${LOG_PATH}/${LOG_FILE}"
            ;;
            * )
                logfile="${LOG_PATH}/${LOG_FILE}"
            ;;
        esac
    fi
}

meilisearch_create_configuration() {
	if [ "${MEILISEARCH_SETUP_TYPE,,}" = "auto" ]; then
        set_config() {
            # $1: key, $2: value, $3: config file, $4: quotes (quotes/false)
            local key="$1"
            local value="$2"
            local file="$3"
            local quotes="${4:-false}"
            if [[ "$value" == \"*\" ]]; then
                quotes="quotes"
                value="${value%\"}"
                value="${value#\"}"
            fi
            if [ "$quotes" = "quotes" ]; then
                value="\"$value\""
            fi
            if grep -qE "^\s*${key}\s*=" "$file"; then
                sudo -u "${MEILISEARCH_USER}" sed -i "s|^\s*${key}\s*=.*|${key} = ${value}|" "$file"
            else
                echo "${key} = ${value}" | silent sudo -u "${MEILISEARCH_USER}" tee  -a "$file"
            fi
        }

        print_notice "Configuring Meilisearch"
        transform_var file \
                            MASTER_KEY

        sanity_var MASTER_KEY "Master API Key for configuring Meilisearch"

        local config_path="${CONFIG_PATH%/}/${CONFIG_FILE}"
        if [ ! -f "${config_path}" ]; then
            sudo -u "${MEILISEARCH_USER}" touch "$config_path"
        fi

        local no_analytics_value="false"
        if var_false "${ENABLE_ANALYTICS,,}"; then
            no_analytics_value="true"
        fi

        set_config env "${ENVIRONMENT}" "${config_path}" quotes
        set_config db_path "${DB_PATH}" "${config_path}" quotes
        set_config http_addr "${LISTEN_IP}:${LISTEN_PORT}" "${config_path}" quotes

        if [ -n "$MASTER_KEY" ]; then set_config master_key "${MASTER_KEY}" "${config_path}" quotes; fi

        set_config no_analytics $no_analytics_value "$config_path"
        set_config http_payload_size_limit "${HTTP_PAYLOAD_SIZE_LIMIT}" "${config_path}" quotes
        set_config log_level "${LOG_LEVEL}" "${config_path}" quotes
        set_config max_indexing_memory "${MAX_INDEXING_MEMORY}" "${config_path}" quotes
        set_config max_indexing_threads ${MAX_INDEXING_THREADS} "$config_path"
        set_config dump_dir "${DUMP_PATH}" "${config_path}" quotes
        set_config ignore_missing_dump ${IGNORE_MISSING_DUMP} "$config_path"
        set_config ignore_dump_if_db_exists ${IGNORE_DUMP_IF_DB_EXISTS} "$config_path"
        set_config schedule_snapshot ${SCHEDULE_SNAPSHOT} "$config_path"
        set_config snapshot_dir "${SNAPSHOT_DIR}" "${config_path}" quotes
        set_config ignore_missing_snapshot ${IGNORE_MISSING_SNAPSHOT} "$config_path"
        if [ -n "${SSL_AUTH_PATH}" ]; then set_config ssl_auth_path "$SSL_AUTH_PATH" "${config_path}" quotes ; fi
        if [ -n "${SSL_CERT_PATH}" ]; then set_config ssl_cert_path "$SSL_CERT_PATH" "${config_path}" quotes ; fi
        if [ -n "${SSL_KEY_PATH}" ] ; then set_config ssl_key_path "$SSL_KEY_PATH" "${config_path}" quotes ; fi
        if [ -n "${SSL_OCSP_PATH}" ]; then set_config ssl_ocsp_path "$SSL_OCSP_PATH" "${config_path}" quotes ; fi
        set_config ssl_require_auth ${SSL_REQUIRE_AUTH} "$config_path"
        set_config ssl_resumption ${SSL_RESUMPTION} "$config_path"
        set_config ssl_tickets ${SSL_TICKETS} "$config_path"

        set_config experimental_enable_metrics ${ENABLE_METRICS} "$config_path"
        set_config experimental_reduce_indexing_memory_usage ${REDUCE_INDEXING_MEMORY_USAGE} "$config_path"

        if [ -n "${MAX_NUMBER_OF_BATCHED_TASKS}" ]; then
            set_config experimental_max_number_of_batched_tasks ${MAX_NUMBER_OF_BATCHED_TASKS} "$config_path"
        fi
    fi
}

meilisearch_configure_monitoring() {
    if var_true "${CONTAINER_ENABLE_MONITORING}" ; then
        source /container/base/defaults/*-monitoring
        case "${CONTAINER_MONITORING_BACKEND,,}" in
            "zabbix" )
                cat <<EOF | silent tee "${ZABBIX_CONFIG_PATH%/}"/"${ZABBIX_CONFIG_FILE}.d"/nfrastack_meilisearch.conf
# Zabbix meilisearch Configuration - Automatically Generated
# Autoregister=meilisearch

EOF
            ;;
        esac
    fi
}
